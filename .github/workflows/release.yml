name: Build and Deploy Binaries

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build binaries
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: nvim-spec-agent
            name: nvim-spec-agent-linux-x64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            binary: nvim-spec-agent
            name: nvim-spec-agent-linux-arm64
            use-cross: true
          - os: macos-latest
            target: x86_64-apple-darwin
            binary: nvim-spec-agent
            name: nvim-spec-agent-macos-x64
          - os: macos-latest
            target: aarch64-apple-darwin
            binary: nvim-spec-agent
            name: nvim-spec-agent-macos-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: nvim-spec-agent.exe
            name: nvim-spec-agent-windows-x64.exe
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cross (Linux ARM64 only)
        if: matrix.use-cross
        run: cargo install cross
      
      - name: Build binary
        run: |
          if [ "${{ matrix.use-cross }}" = "true" ]; then
            cross build --release --target ${{ matrix.target }} --bin nvim-spec-agent
          else
            cargo build --release --target ${{ matrix.target }} --bin nvim-spec-agent
          fi
        shell: bash
      
      - name: Prepare binary
        run: |
          mkdir -p dist
          cp target/${{ matrix.target }}/release/${{ matrix.binary }} dist/${{ matrix.name }}
          chmod +x dist/${{ matrix.name }} || true
        shell: bash
      
      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: dist/${{ matrix.name }}

  deploy:
    name: Deploy to plugin-dist branch
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download all binaries
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Prepare binary distribution
        run: |
          mkdir -p bin
          
          # Copy all downloaded binaries to bin directory
          find artifacts -name "nvim-spec-agent-*" -exec cp {} bin/ \;
          
          # Make Unix binaries executable
          chmod +x bin/nvim-spec-agent-* || true
          
          # Create a selection script
          cat > bin/select-binary.lua << 'LUAEOF'
          -- Auto-select the correct binary for the current platform
          local M = {}
          
          function M.get_binary_path(plugin_dir)
            local os_name = vim.loop.os_uname().sysname:lower()
            local arch = vim.loop.os_uname().machine:lower()
            
            -- Normalize architecture
            if arch == "x86_64" or arch == "amd64" then
              arch = "x64"
            elseif arch == "aarch64" or arch == "arm64" then
              arch = "arm64"
            end
            
            local binary_name
            if os_name:match("linux") then
              binary_name = "nvim-spec-agent-linux-" .. arch
            elseif os_name:match("darwin") then
              binary_name = "nvim-spec-agent-macos-" .. arch
            elseif os_name:match("windows") then
              binary_name = "nvim-spec-agent-windows-" .. arch .. ".exe"
            else
              return nil
            end
            
            local binary_path = plugin_dir .. "/bin/" .. binary_name
            return vim.fn.filereadable(binary_path) == 1 and binary_path or nil
          end
          
          return M
          LUAEOF
      
      - name: Update plugin repository
        run: |
          # Configure git with proper authentication
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # Create plugin-only branch if it doesn't exist
          git checkout -B plugin-dist
          
          # Remove source code, keep only plugin files
          find . -name "*.rs" -delete
          rm -rf src/ target/ Cargo.toml Cargo.lock build.sh build.bat Makefile
          rm -rf .github/workflows/release.yml scripts/
          rm -rf .kiro/ build-config.lua
          
          # Keep the existing README - it already has the correct instructions
          # (No changes needed to README.md)
          
          # Keep only essential plugin files (force add binaries since they're in .gitignore)
          git add -f bin/
          git add lua/ plugin/ autoload/ README.md
          git add -A
          
          # Commit and push with authentication
          git commit -m "Update prebuilt binaries $(date -u +%Y-%m-%d)" || echo "No changes to commit"
          git push -f https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git plugin-dist
          
          # Set plugin-dist as default branch (requires GitHub CLI or API)
          echo "Remember to set plugin-dist as the default branch in GitHub settings!"